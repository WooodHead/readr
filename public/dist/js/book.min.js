function Book(a){this.config={progress:a.progress||0,fx:a.fx||"fadeIn",bookId:a.bookId,bookContentRaw:null,bookContentHtml:null,view:{mode:a.view.mode||"vertical",pageHeight:a.view.pageHeight||910},rendering:{elements:[],view:{pageHeight:null,pageSum:null,windowWidth:null,bookHeight:null}}},this.status={progress:null,page:null,scrollTop:null},this.init()}Book.prototype={init:function(){this.getLocalBookData();var a=(this.config.bookId,this),b=this.config.rendering.view;$(".pages ul").height(a.config.rendering.view.bookHeight),$(window).width()>b.pageWidth?$("body").addClass("hd"):$("body").addClass("mobile"),a.getProgress(function(b){var c=b*a.config.rendering.view.bookHeight;0==c&&(c=1),$("body").scrollTop(c)}),a.handleEvents()},handleEvents:function(){var a=this;$(window).scroll(function(){a.handleScroll.call(a)}),$(window).resize(function(){a.checkView.call(a)||(a.removeBookRenderingData(),location.reload())}),$(".functions .home").tap(function(){location.href="/books"}),$(".functions .clear").tap(function(){localStorage.removeItem("book-"+book_id),localStorage.removeItem("book-"+book_id+"-2"),localStorage.removeItem("book-"+book_id+"-layout"),location.reload()}),$(".view").hasClass("hd")?$("body").on("mousemove",function(a){var b=a.pageY-$("body").scrollTop();a.pageX;90>b?$(".view .functions").slideDown():0==$(".dia-wrap").length&&$(".view .functions").slideUp()}):$(".view").hasClass("mobile")&&$("body").tap(function(){$(".view .functions").slideToggle("fast")})},getLocalBookData:function(){var a=this.config.bookId;localStorage.getItem("book_"+a+"_raw")&&localStorage.getItem("book_"+a+"_html")&&localStorage.getItem("book_"+a+"_rendering")?(this.config.rendering=JSON.parse(localStorage.getItem("book_"+a+"_rendering")),this.config.bookContentHtml=localStorage.getItem("book_"+a+"_html"),this.config.bookContentRaw=localStorage.getItem("book_"+a+"_raw")):this.getBookData(this.renderBook)},renderBook:function(){var a=this.config.bookId,b=this.config.bookContentHtml=localStorage.getItem("book_"+a+"_html"),c=(this.config.bookContentRaw=localStorage.getItem("book_"+a+"_raw"),this.config.view);this.showLoading(),$(".container ul").append("<li class='init'><div class='content'>"+b+"</div></li>"),setTimeout(function(){var b={elements:[],view:{}};$(".pages li .content").children().each(function(a){var c=$(this).height(),d=$(this).prop("tagName");b.elements.push({type:d,height:c})}),b.view.bookHeight=$(".pages ul").height(),b.view.pageSum=Math.ceil($(".pages ul").height()/c.pageHeight),b.view.windowWidth=$(window).width(),b.view.pageHeight=c.pageHeight,b.view.pageWidth=$(".pages ul li").width(),b.view.fontSize=$(".pages ul li .content p").css("font-size"),b.view.lineHeight=$(".pages ul li .content p").css("line-height"),renderingStr=JSON.stringify(b),localStorage.setItem("book_"+a+"_rendering",renderingStr),location.reload()},1e3)},removeBookRenderingData:function(){var a=this.config.bookId;localStorage.removeItem("book_"+a+"_rendering")},showLoading:function(){$("body").hasClass("loading")||($("body").append("<div class='dia-wrap dia_loading'><div class='loading'></div></div>").addClass("loading"),$(".dia-wrap").height($(window).height()))},hideLoading:function(){$(".dia_loading").remove(),$("body").removeClass("loading")},checkView:function(){var a=$(".pages ul li .content p").css("font-size"),b=$(".pages ul li .content p").css("line-height"),c=this.config.rendering.view,d=!0,e=$(".pages ul li").width();return(c.lineHeight!=b||c.fontSize!=a||c.pageWidth!=e)&&(d=!1),d},getBookData:function(a){var b=this.config.bookId,c=this;$.ajax({url:"/api/v0.1/books/"+b+"/content/",type:"GET",dataType:"json",complete:function(a,b){},success:function(d,e,f){d.data?(localStorage.setItem("book_"+b+"_raw",d.data[0].raw),localStorage.setItem("book_"+b+"_html",d.data[0].html),a.call(c)):alert("Wrong book content format!")},error:function(a,b,c){console.log(a),console.log(b),console.log(c)}})},renderPage:function(a){for(var b=this.config.rendering.view,c=this.config.bookContentRaw.split("\n"),d=this.config.rendering,e=0,f=0,g=0,h=!0,i=0,j=0,k=0,l=0,m=0,n=d.elements.length,o="";n>g&&e<b.pageHeight*a;)e=parseInt(d.elements[g].height)+e,f=e-parseInt(d.elements[g].height),e>b.pageHeight*(a-1)&&1==h&&(i=g,k=f-b.pageHeight*(a-1),h=!1),j=g,g++;for(m=j-i+1,l=(a-1)*b.pageHeight,g=i;j>=g;g++)o=g==i?o+"<p style='margin-top: "+k+"px;'>"+c[g]+"</p>":o+"<p>"+c[g]+"</p>";return o="<li class='page_"+a+"' style='top: "+l+"px;height: "+b.pageHeight+"px;'><div class='content'>"+o+"</div><div class='pg_num'>"+a+"</div></li>"},getProgress:function(a){var b=this.config.bookId,c=this,d=localStorage.getItem("book_"+b+"_progress");$.ajax({url:"/api/v0.1/books/"+b+"/progress/",type:"GET",dataType:"json",complete:function(a,b){},success:function(b,e,f){var g;g=b.error?0:b.data[0].reading_progress,b=d&&d>g?d:g,a.call(c,b)},error:function(a,b,c){}})},setProgress:function(a,b){var c=this,d=this.config.bookId;a>1?alert("Parameter p should be percentage!"):(localStorage.setItem("book_"+d+"_progress",a),$.ajax({url:"/api/v0.1/books/"+d+"/progress/",type:"POST",dataType:"json",data:{reading_progress:a},complete:function(a,b){},success:function(a,d,e){b&&b.call(c,a)},error:function(a,b,c){}}))},handleScroll:function(){function a(){var a,b=(f/d.bookHeight).toFixed(4);a=c.convertPercentageToPage(b),c.status.page=a,c.status.scrollTop=f,c.status.progress=b,c.mountPage(a,3),c.setProgress(b),$(".functions .loc").html(a+"/"+e)}var b,c=this,d=c.config.rendering.view,e=(c.config.bookId,d.pageSum),f=$("body").scrollTop();clearTimeout(b);var b=setTimeout(a,100)},convertPercentageToPage:function(a){if(a>1)return alert("Wrong parameter!"),null;var b=this.config.rendering.view,a=parseInt(a*b.pageSum)+1;return a},mountPage:function(a,b){var c=this.config.fx;b=b||1;for(var d=0;b>d;d++)0==$(".pages ul li.page_"+(a+d)).length&&($(".pages ul").append(this.renderPage(a+d)),$(".pages ul li.page_"+(a+d)).addClass("animated "+c))}};
//# sourceMappingURL=book.min.js.map