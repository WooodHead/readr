import React, { Component } from 'react';
import { Link } from 'react-router';
import { connect } from 'react-redux';
import { bindActionCreators } from 'redux';
import ReactCSSTransitionGroup from 'react-addons-css-transition-group';
import Icon from 'elements/Icon';
import Loading from 'components/Loading';
import Dialog from 'elements/Dialog';
import BookPageList from 'components/BookPageList';
import * as renderBook from 'utils/renderBook';
import { getBookView } from 'utils/view';
import { getCache, setCache } from 'utils/cache';
import { simpleCompareObjects } from 'utils/object';
import { fetchBook, fetchBookProgress, userAuth } from 'actions/index';
import apis from 'utils/apis';
import Body from 'side-effects/Body';
import _ from 'lodash';
const actions = { fetchBook, fetchBookProgress, userAuth };
class Viewer extends Component {
    constructor(props) {
        super(props);
        this.bookId = props.params.id;
        this.state = {
            showPanel: true,
            showProgressDialog: false,
            isCalculatingDom: false,
            isReadingMode: false,
            isScrollMode: true,
            isInitialProgressSet: false,
            scrollTop: 0,
            currentPage: 0,
            calculatedPages: null,
            latestProgress: 0,
            view: getBookView()
        };
    }
    scrollTo(position) {
        let pageCount = this.state.calculatedPages.props.children.length;
        let pageHeight = this.state.calculatedPages.props.view.pageHeight;
        let height = pageCount * pageHeight;
        if (position < 1) {
            this.setState({
                currentPage: renderBook.percentageToPage(position, pageCount),
                scrollTop: position * height
            });
            document.body.scrollTop = pageCount * pageHeight * position;
        }
        else {
            this.setState({
                currentPage: position,
                scrollTop: height * position / pageCount
            });
            document.body.scrollTop = pageHeight * position;
        }
    }
    addEventListeners() {
        this.mapScrollTopToState = () => {
            this.setState({
                scrollTop: document.body.scrollTop
            });
        };
        this.mapWindowWidthToState = () => {
            this.setState({
                windowWidth: window.innerWidth
            });
        };
        this.mapViewToState = () => {
            this.setState({
                view: getBookView()
            });
        };
        this.checkAndSetProgress = () => {
            let currentPageNo = this.props.book.pageNo;
            this.props.actions.fetchBookProgress(this.bookId).then(action => {
                if (this.props.book.pageNo - currentPageNo > 5) {
                    this.setState({
                        showProgressDialog: true,
                        latestProgress: this.props.book.percentage
                    });
                }
                else {
                    let pageSum = this.state.calculatedPages.props.children.length;
                    let height = pageSum * this.state.view.pageHeight;
                    let percentage = this.state.scrollTop / height;
                    let pageNo = renderBook.percentageToPage(percentage, pageSum);
                    let progress = {
                        pageNo,
                        pageSum,
                        percentage
                    };
                    apis.setProgress(this.bookId, progress);
                }
            });
        };
        // TODO: use session to determine latest progress
        this.deboundedSetProgress = _.debounce(this.checkAndSetProgress, 200);
        window.addEventListener('scroll', this.deboundedSetProgress);
        window.addEventListener('scroll', this.mapScrollTopToState);
        window.addEventListener('resize', this.mapWindowWidthToState);
        window.addEventListener('resize', this.mapViewToState);
    }
    removeEventListeners() {
        window.removeEventListener('scroll', this.deboundedSetProgress);
        window.removeEventListener('scroll', this.mapScrollTopToState);
        window.removeEventListener('resize', this.mapWindowWidthToState);
        window.removeEventListener('resize', this.mapViewToState);
    }
    toggleBookPanel(event) {
        if (this.state.calculatedPages.props.view.screen === 'hd') {
            var y = event.pageY - document.body.scrollTop;
            if (y < 90) {
                this.setState({
                    showPanel: true
                });
            }
            else {
                this.setState({
                    showPanel: false
                });
            }
        }
    }
    clickToToggleBookPanel() {
        if (this.state.calculatedPages.props.view.screen === 'phone') {
            this.setState({
                showPanel: !this.state.showPanel
            });
        }
    }
    calculateDom() {
        let html = this.state.bookHtml;
        let bookId = this.bookId;
        let view = getBookView();
        let nodeHeights = renderBook.getNodeHeights(this.refs.bookHtml.childNodes);
        let pages = renderBook.htmlToPages(html, nodeHeights, view);
        setCache(`book${bookId}_pages`, JSON.stringify(pages));
        this.setState({
            isReadingMode: true,
            isCalculatingDom: false,
            calculatedPages: pages
        });
    }
    loadCalculatedPages() {
        const bookId = this.props.params.id;
        let pages = getCache(`book${bookId}_pages`);
        // check if pages are cached
        if (pages) {
            pages = JSON.parse(pages);
            this.setState({
                isReadingMode: true,
                calculatedPages: pages,
                bookHtml: renderBook.pagesToHtml(pages)
            });
        }
        else {
            this.props.actions.fetchBook(bookId, ['content']);
        }
    }
    componentWillUpdate(nextProps, nextState) {
        if (nextProps.book && nextProps.book.content && nextProps.book.content.html && !this.props.book.content) {
            this.setState({
                isCalculatingDom: true,
                bookHtml: nextProps.book.content.html
            });
        }
        if (!simpleCompareObjects(this.state.view, nextState.view)) {
            this.setState({
                isCalculatingDom: true,
            });
        }
    }
    componentDidUpdate(prevProps, prevState) {
        if (this.state.isCalculatingDom && !prevState.isCalculatingDom) {
            this.calculateDom();
        }
        // scroll to previous reading progress when opening a book
        if (this.props.book && this.props.book.percentage && this.state.calculatedPages && !this.state.isInitialProgressSet) {
            setTimeout(() => {
                this.scrollTo(this.props.book.percentage);
                this.setState({
                    isInitialProgressSet: true
                });
            }, 1);
        }
    }
    componentDidMount() {
        const actions = this.props.actions;
        const bookId = this.props.params.id;
        actions.userAuth();
        actions.fetchBook(bookId);
        actions.fetchBookProgress(bookId);
        this.addEventListeners();
        this.loadCalculatedPages();
    }
    componentWillUnmount() {
        this.removeEventListeners();
        this.setState({
            isInitialProgressSet: false
        });
    }
    renderBook() {
        let scrollTop = this.state.scrollTop;
        let calculatedPages = this.state.calculatedPages;
        let bookId = this.props.params.id;
        let view = calculatedPages.props.view;
        let height = calculatedPages.props.children.length * view.pageHeight;
        let currentPage = renderBook.percentageToPage(scrollTop / height, calculatedPages.props.children.length);
        let pages = renderBook.filterPages({
            startPage: currentPage,
            offset: 2,
            quantity: 5,
            pages: calculatedPages.props.children
        });
        return (React.createElement("div", {onClick: this.clickToToggleBookPanel.bind(this)}, React.createElement(BookPageList, {height: height, view: view, bookId: bookId, pages: pages})));
    }
    hideProgressDialog() {
        this.setState({
            showProgressDialog: false
        });
    }
    render() {
        let book = this.props.book;
        let view = this.state.view;
        let actions = [
            {
                text: 'Yes',
                function: () => {
                    this.scrollTo.call(this, this.state.latestProgress);
                    this.hideProgressDialog.call(this);
                }
            },
            {
                text: 'No',
                function: this.hideProgressDialog.bind(this)
            }
        ];
        return (React.createElement("div", {className: `viewer viewer--${view.screen}`, onMouseMove: this.toggleBookPanel.bind(this)}, React.createElement(Body, {className: "viewer"}), !book.content && !this.state.calculatedPages ? (React.createElement(Loading, null)) : null, this.state.showProgressDialog ? (React.createElement(Dialog, {actions: actions, content: "are you sure?"})) : null, React.createElement(ReactCSSTransitionGroup, {component: "div", transitionName: "slide", transitionEnterTimeout: 300, transitionLeaveTimeout: 300}, this.state.showPanel && this.state.isReadingMode ? (React.createElement("div", {className: "viewer-panel"}, React.createElement("div", {className: "container"}, React.createElement("div", {className: "back"}, React.createElement(Link, {to: "/"}, React.createElement(Icon, {name: "back"}), React.createElement("span", null, "返回"))), React.createElement("span", {className: "title"}, book.title)))) : null), (this.state.isCalculatingDom && this.state.bookHtml) ? (React.createElement("ul", {className: "pages"}, React.createElement("li", null, React.createElement("div", {ref: "bookHtml", className: "content", dangerouslySetInnerHTML: { __html: this.state.bookHtml }})))) : null, this.state.isReadingMode ? (this.renderBook()) : null));
    }
}
export default connect((state, ownProps) => {
    return {
        book: state.entities.books[ownProps.params.id] ? state.entities.books[ownProps.params.id] : {},
        session: state.session
    };
}, dispatch => ({
    actions: bindActionCreators(actions, dispatch)
}))(Viewer);

//# sourceMappingURL=data:application/json;base64,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SUFBQyxTQUFTLEVBQUMsT0FBTyxHQUNuQixxQkFBQyxFQUFFLFNBQ0QscUJBQUMsR0FBRyxJQUFDLEdBQUcsRUFBQyxVQUFVLEVBQUMsU0FBUyxFQUFDLFNBQVMsRUFBQyx1QkFBdUIsRUFBRSxFQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxFQUFPLENBQ25HLENBQ0YsQ0FDTixHQUFDLElBQ0gsRUFFQyxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsR0FBQyxDQUN2QixJQUFJLENBQUMsVUFBVSxFQUFFLENBQ2xCLEdBQUMsSUFDSCxDQUNHLENBQ1AsQ0FBQTtJQUNILENBQUM7QUFDSCxDQUFDO0FBRUQsZUFBZSxPQUFPLENBQ3BCLENBQUMsS0FBSyxFQUFFLFFBQWE7SUFDbkIsTUFBTSxDQUFDO1FBQ0wsSUFBSSxFQUFFLEtBQUssQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLEdBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsR0FBQyxFQUFFO1FBQzFGLE9BQU8sRUFBRSxLQUFLLENBQUMsT0FBTztLQUN2QixDQUFBO0FBQ0gsQ0FBQyxFQUNELFFBQVEsSUFBSSxDQUFDO0lBQ1gsT0FBTyxFQUFFLGtCQUFrQixDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUM7Q0FDL0MsQ0FBQyxDQUNILENBQUMsTUFBTSxDQUFDLENBQUEiLCJmaWxlIjoiY29udGFpbmVycy9WaWV3ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgQ29tcG9uZW50IH0gZnJvbSAncmVhY3QnXG5pbXBvcnQgeyBMaW5rIH0gZnJvbSAncmVhY3Qtcm91dGVyJ1xuaW1wb3J0IHsgY29ubmVjdCB9IGZyb20gJ3JlYWN0LXJlZHV4J1xuaW1wb3J0IHsgYmluZEFjdGlvbkNyZWF0b3JzIH0gZnJvbSAncmVkdXgnXG5pbXBvcnQgUmVhY3RDU1NUcmFuc2l0aW9uR3JvdXAgZnJvbSAncmVhY3QtYWRkb25zLWNzcy10cmFuc2l0aW9uLWdyb3VwJ1xuaW1wb3J0IEljb24gZnJvbSAnZWxlbWVudHMvSWNvbidcbmltcG9ydCBMb2FkaW5nIGZyb20gJ2NvbXBvbmVudHMvTG9hZGluZydcbmltcG9ydCBEaWFsb2cgZnJvbSAnZWxlbWVudHMvRGlhbG9nJ1xuaW1wb3J0IEJvb2tQYWdlTGlzdCBmcm9tICdjb21wb25lbnRzL0Jvb2tQYWdlTGlzdCdcbmltcG9ydCAqIGFzIHJlbmRlckJvb2sgZnJvbSAndXRpbHMvcmVuZGVyQm9vaydcbmltcG9ydCBjYWxsQXBpIGZyb20gJ3V0aWxzL2NhbGxBcGknXG5pbXBvcnQgeyBnZXRCb29rVmlldyB9IGZyb20gJ3V0aWxzL3ZpZXcnXG5pbXBvcnQgeyBnZXRDYWNoZSwgc2V0Q2FjaGUgfSBmcm9tICd1dGlscy9jYWNoZSdcbmltcG9ydCB7IHNpbXBsZUNvbXBhcmVPYmplY3RzIH0gZnJvbSAndXRpbHMvb2JqZWN0J1xuaW1wb3J0IHsgZmV0Y2hCb29rLCBmZXRjaEJvb2tQcm9ncmVzcywgdXNlckF1dGggfSBmcm9tICdhY3Rpb25zL2luZGV4J1xuaW1wb3J0IGFwaXMgZnJvbSAndXRpbHMvYXBpcydcbmltcG9ydCBCb2R5IGZyb20gJ3NpZGUtZWZmZWN0cy9Cb2R5J1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJ1xuXG5jb25zdCBhY3Rpb25zID0geyBmZXRjaEJvb2ssIGZldGNoQm9va1Byb2dyZXNzLCB1c2VyQXV0aCB9XG5cbmNsYXNzIFZpZXdlciBleHRlbmRzIENvbXBvbmVudDxhbnksIGFueT4ge1xuICBcbiAgYm9va0lkOiBudW1iZXJcbiAgbWFwU2Nyb2xsVG9wVG9TdGF0ZTogKCkgPT4gdm9pZFxuICBtYXBXaW5kb3dXaWR0aFRvU3RhdGU6ICgpID0+IHZvaWRcbiAgbWFwVmlld1RvU3RhdGU6ICgpID0+IHZvaWRcbiAgY2hlY2tBbmRTZXRQcm9ncmVzczogKCkgPT4gdm9pZFxuICBkZWJvdW5kZWRTZXRQcm9ncmVzczogKCkgPT4gdm9pZFxuICByZWZzOiB7XG4gICAgICBbc3RyaW5nOiBzdHJpbmddOiBhbnlcbiAgICAgIGJvb2tIdG1sOiBhbnlcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgc3VwZXIocHJvcHMpXG5cbiAgICB0aGlzLmJvb2tJZCA9IHByb3BzLnBhcmFtcy5pZFxuICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICBzaG93UGFuZWw6IHRydWUsXG4gICAgICBzaG93UHJvZ3Jlc3NEaWFsb2c6IGZhbHNlLFxuXG4gICAgICBpc0NhbGN1bGF0aW5nRG9tOiBmYWxzZSxcbiAgICAgIGlzUmVhZGluZ01vZGU6IGZhbHNlLFxuICAgICAgaXNTY3JvbGxNb2RlOiB0cnVlLFxuICAgICAgaXNJbml0aWFsUHJvZ3Jlc3NTZXQ6IGZhbHNlLFxuXG4gICAgICBzY3JvbGxUb3A6IDAsXG4gICAgICBjdXJyZW50UGFnZTogMCwgLy8gVE9ETzogcmVtb3ZlP1xuICAgICAgY2FsY3VsYXRlZFBhZ2VzOiBudWxsLFxuICAgICAgbGF0ZXN0UHJvZ3Jlc3M6IDAsXG4gICAgICB2aWV3OiBnZXRCb29rVmlldygpXG4gICAgfVxuICB9XG5cbiAgc2Nyb2xsVG8ocG9zaXRpb24pIHtcbiAgICBsZXQgcGFnZUNvdW50ID0gdGhpcy5zdGF0ZS5jYWxjdWxhdGVkUGFnZXMucHJvcHMuY2hpbGRyZW4ubGVuZ3RoXG4gICAgbGV0IHBhZ2VIZWlnaHQgPSB0aGlzLnN0YXRlLmNhbGN1bGF0ZWRQYWdlcy5wcm9wcy52aWV3LnBhZ2VIZWlnaHRcbiAgICBsZXQgaGVpZ2h0ID0gcGFnZUNvdW50ICogcGFnZUhlaWdodFxuXG4gICAgaWYocG9zaXRpb24gPCAxKSB7XG4gICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgY3VycmVudFBhZ2U6IHJlbmRlckJvb2sucGVyY2VudGFnZVRvUGFnZShwb3NpdGlvbiwgcGFnZUNvdW50KSxcbiAgICAgICAgc2Nyb2xsVG9wOiBwb3NpdGlvbiAqIGhlaWdodFxuICAgICAgfSlcbiAgICAgIGRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wID0gcGFnZUNvdW50ICogcGFnZUhlaWdodCAqIHBvc2l0aW9uXG4gICAgfWVsc2V7XG4gICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgY3VycmVudFBhZ2U6IHBvc2l0aW9uLFxuICAgICAgICBzY3JvbGxUb3A6IGhlaWdodCAqIHBvc2l0aW9uIC8gcGFnZUNvdW50XG4gICAgICB9KVxuICAgICAgZG9jdW1lbnQuYm9keS5zY3JvbGxUb3AgPSBwYWdlSGVpZ2h0ICogcG9zaXRpb25cbiAgICB9XG4gIH1cblxuICBhZGRFdmVudExpc3RlbmVycygpIHtcbiAgICB0aGlzLm1hcFNjcm9sbFRvcFRvU3RhdGUgPSAoKSA9PiB7XG4gICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgc2Nyb2xsVG9wOiBkb2N1bWVudC5ib2R5LnNjcm9sbFRvcFxuICAgICAgfSlcbiAgICB9XG5cbiAgICB0aGlzLm1hcFdpbmRvd1dpZHRoVG9TdGF0ZSA9ICgpID0+IHtcbiAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICB3aW5kb3dXaWR0aDogd2luZG93LmlubmVyV2lkdGhcbiAgICAgIH0pXG4gICAgfVxuXG4gICAgdGhpcy5tYXBWaWV3VG9TdGF0ZSA9ICgpID0+IHtcbiAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICB2aWV3OiBnZXRCb29rVmlldygpXG4gICAgICB9KVxuICAgIH1cblxuICAgIHRoaXMuY2hlY2tBbmRTZXRQcm9ncmVzcyA9ICgpID0+IHtcbiAgICAgIGxldCBjdXJyZW50UGFnZU5vID0gdGhpcy5wcm9wcy5ib29rLnBhZ2VOb1xuICAgICAgdGhpcy5wcm9wcy5hY3Rpb25zLmZldGNoQm9va1Byb2dyZXNzKHRoaXMuYm9va0lkKS50aGVuKGFjdGlvbiA9PiB7XG4gICAgICAgIGlmKHRoaXMucHJvcHMuYm9vay5wYWdlTm8gLSBjdXJyZW50UGFnZU5vID4gNSkge1xuICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgc2hvd1Byb2dyZXNzRGlhbG9nOiB0cnVlLFxuICAgICAgICAgICAgbGF0ZXN0UHJvZ3Jlc3M6IHRoaXMucHJvcHMuYm9vay5wZXJjZW50YWdlXG4gICAgICAgICAgfSlcbiAgICAgICAgfWVsc2V7XG4gICAgICAgICAgbGV0IHBhZ2VTdW0gPSB0aGlzLnN0YXRlLmNhbGN1bGF0ZWRQYWdlcy5wcm9wcy5jaGlsZHJlbi5sZW5ndGhcbiAgICAgICAgICBsZXQgaGVpZ2h0ID0gcGFnZVN1bSAqIHRoaXMuc3RhdGUudmlldy5wYWdlSGVpZ2h0XG4gICAgICAgICAgbGV0IHBlcmNlbnRhZ2UgPSB0aGlzLnN0YXRlLnNjcm9sbFRvcC9oZWlnaHRcbiAgICAgICAgICBsZXQgcGFnZU5vID0gcmVuZGVyQm9vay5wZXJjZW50YWdlVG9QYWdlKHBlcmNlbnRhZ2UsIHBhZ2VTdW0pXG5cbiAgICAgICAgICBsZXQgcHJvZ3Jlc3MgPSB7XG4gICAgICAgICAgICBwYWdlTm8sXG4gICAgICAgICAgICBwYWdlU3VtLFxuICAgICAgICAgICAgcGVyY2VudGFnZVxuICAgICAgICAgIH1cblxuICAgICAgICAgIGFwaXMuc2V0UHJvZ3Jlc3ModGhpcy5ib29rSWQsIHByb2dyZXNzKVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH1cblxuICAgIC8vIFRPRE86IHVzZSBzZXNzaW9uIHRvIGRldGVybWluZSBsYXRlc3QgcHJvZ3Jlc3NcbiAgICB0aGlzLmRlYm91bmRlZFNldFByb2dyZXNzID0gXy5kZWJvdW5jZSh0aGlzLmNoZWNrQW5kU2V0UHJvZ3Jlc3MsIDIwMClcblxuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdzY3JvbGwnLCB0aGlzLmRlYm91bmRlZFNldFByb2dyZXNzKVxuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdzY3JvbGwnLCB0aGlzLm1hcFNjcm9sbFRvcFRvU3RhdGUpXG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHRoaXMubWFwV2luZG93V2lkdGhUb1N0YXRlKVxuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCB0aGlzLm1hcFZpZXdUb1N0YXRlKVxuICB9XG5cbiAgcmVtb3ZlRXZlbnRMaXN0ZW5lcnMoKSB7XG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIHRoaXMuZGVib3VuZGVkU2V0UHJvZ3Jlc3MpXG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIHRoaXMubWFwU2Nyb2xsVG9wVG9TdGF0ZSlcbiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigncmVzaXplJywgdGhpcy5tYXBXaW5kb3dXaWR0aFRvU3RhdGUpXG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHRoaXMubWFwVmlld1RvU3RhdGUpXG4gIH1cblxuICB0b2dnbGVCb29rUGFuZWwoZXZlbnQpIHtcbiAgICBpZih0aGlzLnN0YXRlLmNhbGN1bGF0ZWRQYWdlcy5wcm9wcy52aWV3LnNjcmVlbiA9PT0gJ2hkJykge1xuICAgICAgdmFyIHkgPSBldmVudC5wYWdlWSAtIGRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wXG5cbiAgICAgIGlmKHkgPCA5MCl7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgIHNob3dQYW5lbDogdHJ1ZVxuICAgICAgICB9KVxuICAgICAgfWVsc2V7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgIHNob3dQYW5lbDogZmFsc2VcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBjbGlja1RvVG9nZ2xlQm9va1BhbmVsKCkge1xuICAgIGlmKHRoaXMuc3RhdGUuY2FsY3VsYXRlZFBhZ2VzLnByb3BzLnZpZXcuc2NyZWVuID09PSAncGhvbmUnKSB7XG4gICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgc2hvd1BhbmVsOiAhdGhpcy5zdGF0ZS5zaG93UGFuZWxcbiAgICAgIH0pXG4gICAgfVxuICB9XG5cbiAgY2FsY3VsYXRlRG9tKCkge1xuICAgIGxldCBodG1sID0gdGhpcy5zdGF0ZS5ib29rSHRtbFxuICAgIGxldCBib29rSWQgPSB0aGlzLmJvb2tJZFxuICAgIGxldCB2aWV3ID0gZ2V0Qm9va1ZpZXcoKVxuICAgIGxldCBub2RlSGVpZ2h0cyA9IHJlbmRlckJvb2suZ2V0Tm9kZUhlaWdodHModGhpcy5yZWZzLmJvb2tIdG1sLmNoaWxkTm9kZXMpXG4gICAgbGV0IHBhZ2VzID0gcmVuZGVyQm9vay5odG1sVG9QYWdlcyhodG1sLCBub2RlSGVpZ2h0cywgdmlldylcblxuICAgIHNldENhY2hlKGBib29rJHtib29rSWR9X3BhZ2VzYCwgSlNPTi5zdHJpbmdpZnkocGFnZXMpKVxuXG4gICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICBpc1JlYWRpbmdNb2RlOiB0cnVlLFxuICAgICAgaXNDYWxjdWxhdGluZ0RvbTogZmFsc2UsXG4gICAgICBjYWxjdWxhdGVkUGFnZXM6IHBhZ2VzXG4gICAgfSlcbiAgfVxuXG4gIGxvYWRDYWxjdWxhdGVkUGFnZXMoKSB7XG4gICAgY29uc3QgYm9va0lkID0gdGhpcy5wcm9wcy5wYXJhbXMuaWRcbiAgICBsZXQgcGFnZXMgPSBnZXRDYWNoZShgYm9vayR7Ym9va0lkfV9wYWdlc2ApXG5cbiAgICAvLyBjaGVjayBpZiBwYWdlcyBhcmUgY2FjaGVkXG4gICAgaWYocGFnZXMpe1xuICAgICAgcGFnZXMgPSBKU09OLnBhcnNlKHBhZ2VzKVxuXG4gICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgaXNSZWFkaW5nTW9kZTogdHJ1ZSxcbiAgICAgICAgY2FsY3VsYXRlZFBhZ2VzOiBwYWdlcyxcbiAgICAgICAgYm9va0h0bWw6IHJlbmRlckJvb2sucGFnZXNUb0h0bWwocGFnZXMpXG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnByb3BzLmFjdGlvbnMuZmV0Y2hCb29rKGJvb2tJZCwgWydjb250ZW50J10pXG4gICAgfVxuICB9XG5cbiAgY29tcG9uZW50V2lsbFVwZGF0ZShuZXh0UHJvcHMsIG5leHRTdGF0ZSkge1xuICAgIGlmKG5leHRQcm9wcy5ib29rICYmIG5leHRQcm9wcy5ib29rLmNvbnRlbnQgJiYgbmV4dFByb3BzLmJvb2suY29udGVudC5odG1sICYmICF0aGlzLnByb3BzLmJvb2suY29udGVudCkge1xuICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgIGlzQ2FsY3VsYXRpbmdEb206IHRydWUsXG4gICAgICAgIGJvb2tIdG1sOiBuZXh0UHJvcHMuYm9vay5jb250ZW50Lmh0bWxcbiAgICAgIH0pXG4gICAgfVxuXG4gICAgaWYoIXNpbXBsZUNvbXBhcmVPYmplY3RzKHRoaXMuc3RhdGUudmlldywgbmV4dFN0YXRlLnZpZXcpKSB7XG4gICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgaXNDYWxjdWxhdGluZ0RvbTogdHJ1ZSxcbiAgICAgIH0pXG4gICAgfVxuICB9XG5cbiAgY29tcG9uZW50RGlkVXBkYXRlKHByZXZQcm9wcywgcHJldlN0YXRlKSB7XG4gICAgaWYodGhpcy5zdGF0ZS5pc0NhbGN1bGF0aW5nRG9tICYmICFwcmV2U3RhdGUuaXNDYWxjdWxhdGluZ0RvbSkge1xuICAgICAgdGhpcy5jYWxjdWxhdGVEb20oKVxuICAgIH1cblxuICAgIC8vIHNjcm9sbCB0byBwcmV2aW91cyByZWFkaW5nIHByb2dyZXNzIHdoZW4gb3BlbmluZyBhIGJvb2tcbiAgICBpZih0aGlzLnByb3BzLmJvb2sgJiYgdGhpcy5wcm9wcy5ib29rLnBlcmNlbnRhZ2UgJiYgdGhpcy5zdGF0ZS5jYWxjdWxhdGVkUGFnZXMgJiYgIXRoaXMuc3RhdGUuaXNJbml0aWFsUHJvZ3Jlc3NTZXQpIHtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICB0aGlzLnNjcm9sbFRvKHRoaXMucHJvcHMuYm9vay5wZXJjZW50YWdlKVxuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICBpc0luaXRpYWxQcm9ncmVzc1NldDogdHJ1ZVxuICAgICAgICB9KVxuICAgICAgfSwgMSlcbiAgICB9XG4gIH1cblxuICBjb21wb25lbnREaWRNb3VudCgpIHtcbiAgICBjb25zdCBhY3Rpb25zID0gdGhpcy5wcm9wcy5hY3Rpb25zXG4gICAgY29uc3QgYm9va0lkID0gdGhpcy5wcm9wcy5wYXJhbXMuaWRcblxuICAgIGFjdGlvbnMudXNlckF1dGgoKVxuICAgIGFjdGlvbnMuZmV0Y2hCb29rKGJvb2tJZClcbiAgICBhY3Rpb25zLmZldGNoQm9va1Byb2dyZXNzKGJvb2tJZClcblxuICAgIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcnMoKVxuICAgIHRoaXMubG9hZENhbGN1bGF0ZWRQYWdlcygpXG4gIH1cblxuICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICB0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXJzKClcbiAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgIGlzSW5pdGlhbFByb2dyZXNzU2V0OiBmYWxzZVxuICAgIH0pXG4gIH1cblxuICByZW5kZXJCb29rKCkge1xuICAgIGxldCBzY3JvbGxUb3AgPSB0aGlzLnN0YXRlLnNjcm9sbFRvcFxuICAgIGxldCBjYWxjdWxhdGVkUGFnZXMgPSB0aGlzLnN0YXRlLmNhbGN1bGF0ZWRQYWdlc1xuICAgIGxldCBib29rSWQgPSB0aGlzLnByb3BzLnBhcmFtcy5pZFxuICAgIGxldCB2aWV3ID0gY2FsY3VsYXRlZFBhZ2VzLnByb3BzLnZpZXdcbiAgICBsZXQgaGVpZ2h0ID0gY2FsY3VsYXRlZFBhZ2VzLnByb3BzLmNoaWxkcmVuLmxlbmd0aCAqIHZpZXcucGFnZUhlaWdodFxuICAgIGxldCBjdXJyZW50UGFnZSA9IHJlbmRlckJvb2sucGVyY2VudGFnZVRvUGFnZShzY3JvbGxUb3AvaGVpZ2h0LCBjYWxjdWxhdGVkUGFnZXMucHJvcHMuY2hpbGRyZW4ubGVuZ3RoKVxuXG4gICAgbGV0IHBhZ2VzID0gcmVuZGVyQm9vay5maWx0ZXJQYWdlcyh7XG4gICAgICBzdGFydFBhZ2U6IGN1cnJlbnRQYWdlLFxuICAgICAgb2Zmc2V0OiAyLFxuICAgICAgcXVhbnRpdHk6IDUsXG4gICAgICBwYWdlczogY2FsY3VsYXRlZFBhZ2VzLnByb3BzLmNoaWxkcmVuXG4gICAgfSlcblxuICAgIHJldHVybiAoXG4gICAgICA8ZGl2IG9uQ2xpY2s9e3RoaXMuY2xpY2tUb1RvZ2dsZUJvb2tQYW5lbC5iaW5kKHRoaXMpfT5cbiAgICAgICAgPEJvb2tQYWdlTGlzdCBoZWlnaHQ9e2hlaWdodH0gdmlldz17dmlld30gYm9va0lkPXtib29rSWR9IHBhZ2VzPXtwYWdlc30gLz5cbiAgICAgIDwvZGl2PlxuICAgIClcbiAgfVxuXG4gIGhpZGVQcm9ncmVzc0RpYWxvZygpIHtcbiAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgIHNob3dQcm9ncmVzc0RpYWxvZzogZmFsc2VcbiAgICB9KVxuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIGxldCBib29rID0gdGhpcy5wcm9wcy5ib29rXG4gICAgbGV0IHZpZXcgPSB0aGlzLnN0YXRlLnZpZXdcbiAgICBsZXQgYWN0aW9ucyA9IFtcbiAgICAgIHtcbiAgICAgICAgdGV4dDogJ1llcycsXG4gICAgICAgIGZ1bmN0aW9uOiAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5zY3JvbGxUby5jYWxsKHRoaXMsIHRoaXMuc3RhdGUubGF0ZXN0UHJvZ3Jlc3MpXG4gICAgICAgICAgdGhpcy5oaWRlUHJvZ3Jlc3NEaWFsb2cuY2FsbCh0aGlzKVxuICAgICAgICB9XG4gICAgICB9LFxuICAgICAge1xuICAgICAgICB0ZXh0OiAnTm8nLFxuICAgICAgICBmdW5jdGlvbjogdGhpcy5oaWRlUHJvZ3Jlc3NEaWFsb2cuYmluZCh0aGlzKVxuICAgICAgfVxuICAgIF1cblxuICAgIHJldHVybiAoXG4gICAgICA8ZGl2IGNsYXNzTmFtZT17YHZpZXdlciB2aWV3ZXItLSR7dmlldy5zY3JlZW59YH0gb25Nb3VzZU1vdmU9e3RoaXMudG9nZ2xlQm9va1BhbmVsLmJpbmQodGhpcyl9ID5cbiAgICAgICAgPEJvZHkgY2xhc3NOYW1lPVwidmlld2VyXCIgLz5cbiAgICAgICAge1xuICAgICAgICAgICFib29rLmNvbnRlbnQgJiYgIXRoaXMuc3RhdGUuY2FsY3VsYXRlZFBhZ2VzID8oXG4gICAgICAgICAgICA8TG9hZGluZyAvPlxuICAgICAgICAgICk6bnVsbFxuICAgICAgICB9XG4gICAgICAgIHtcbiAgICAgICAgICB0aGlzLnN0YXRlLnNob3dQcm9ncmVzc0RpYWxvZz8gKFxuICAgICAgICAgICAgPERpYWxvZyBhY3Rpb25zPXthY3Rpb25zfSBjb250ZW50PVwiYXJlIHlvdSBzdXJlP1wiLz5cbiAgICAgICAgICApOm51bGxcbiAgICAgICAgfVxuICAgICAgICA8UmVhY3RDU1NUcmFuc2l0aW9uR3JvdXBcbiAgICAgICAgICBjb21wb25lbnQ9XCJkaXZcIlxuICAgICAgICAgIHRyYW5zaXRpb25OYW1lPVwic2xpZGVcIlxuICAgICAgICAgIHRyYW5zaXRpb25FbnRlclRpbWVvdXQ9ezMwMH1cbiAgICAgICAgICB0cmFuc2l0aW9uTGVhdmVUaW1lb3V0PXszMDB9XG4gICAgICAgID5cbiAgICAgICAgICB7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLnNob3dQYW5lbCAmJiB0aGlzLnN0YXRlLmlzUmVhZGluZ01vZGUgPyhcbiAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJ2aWV3ZXItcGFuZWxcIj5cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cImNvbnRhaW5lclwiPlxuICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJiYWNrXCI+XG4gICAgICAgICAgICAgICAgICAgIDxMaW5rIHRvPVwiL1wiPlxuICAgICAgICAgICAgICAgICAgICAgIDxJY29uIG5hbWU9XCJiYWNrXCIgLz5cbiAgICAgICAgICAgICAgICAgICAgICA8c3Bhbj7ov5Tlm548L3NwYW4+XG4gICAgICAgICAgICAgICAgICAgIDwvTGluaz5cbiAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3NOYW1lPVwidGl0bGVcIj57Ym9vay50aXRsZX08L3NwYW4+XG4gICAgICAgICAgICAgICAgICB7Lyo8ZGl2IGNsYXNzTmFtZT1cInByZWZlcmVuY2VcIj5cbiAgICAgICAgICAgICAgICAgICAgPEljb24gbmFtZT1cImZvbnRcIiAvPlxuICAgICAgICAgICAgICAgICAgPC9kaXY+Ki99XG4gICAgICAgICAgICAgICAgICB7Lyo8c3BhbiBjbGFzc05hbWU9XCJsb2NcIj57Ym9vay5jdXJyZW50UGFnZStcIi9cIitwYWdlcy5sZW5ndGh9PC9zcGFuPiovfVxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICk6bnVsbFxuICAgICAgICAgIH1cbiAgICAgICAgPC9SZWFjdENTU1RyYW5zaXRpb25Hcm91cD5cbiAgICAgICAge1xuICAgICAgICAgICh0aGlzLnN0YXRlLmlzQ2FsY3VsYXRpbmdEb20gJiYgdGhpcy5zdGF0ZS5ib29rSHRtbCk/KFxuICAgICAgICAgICAgPHVsIGNsYXNzTmFtZT1cInBhZ2VzXCI+XG4gICAgICAgICAgICAgIDxsaT5cbiAgICAgICAgICAgICAgICA8ZGl2IHJlZj1cImJvb2tIdG1sXCIgY2xhc3NOYW1lPVwiY29udGVudFwiIGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MPXt7X19odG1sOiB0aGlzLnN0YXRlLmJvb2tIdG1sfX0+PC9kaXY+XG4gICAgICAgICAgICAgIDwvbGk+XG4gICAgICAgICAgICA8L3VsPlxuICAgICAgICAgICk6bnVsbFxuICAgICAgICB9XG4gICAgICAgIHtcbiAgICAgICAgICB0aGlzLnN0YXRlLmlzUmVhZGluZ01vZGU/KFxuICAgICAgICAgICAgdGhpcy5yZW5kZXJCb29rKClcbiAgICAgICAgICApOm51bGxcbiAgICAgICAgfVxuICAgICAgPC9kaXY+XG4gICAgKVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNvbm5lY3QoXG4gIChzdGF0ZSwgb3duUHJvcHM6IGFueSkgPT4ge1xuICAgIHJldHVybiB7XG4gICAgICBib29rOiBzdGF0ZS5lbnRpdGllcy5ib29rc1tvd25Qcm9wcy5wYXJhbXMuaWRdP3N0YXRlLmVudGl0aWVzLmJvb2tzW293blByb3BzLnBhcmFtcy5pZF06e30sXG4gICAgICBzZXNzaW9uOiBzdGF0ZS5zZXNzaW9uXG4gICAgfVxuICB9LFxuICBkaXNwYXRjaCA9PiAoe1xuICAgIGFjdGlvbnM6IGJpbmRBY3Rpb25DcmVhdG9ycyhhY3Rpb25zLCBkaXNwYXRjaClcbiAgfSlcbikoVmlld2VyKVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
