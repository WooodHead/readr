import 'isomorphic-fetch';
import { normalize } from 'normalizr';
import humps from 'humps';
import objectToUrlencoded from 'utils/objectToUrlencoded';
export function handleResponseJson(json, schema) {
    json = humps.camelizeKeys(json);
    let result = json;
    if (typeof schema !== 'undefined') {
        result = Object.assign({}, normalize(json, schema));
    }
    return result;
}
export function callApi(options) {
    let { fullUrl, method, data, schema, includeCredentials, useJsonp, contentType } = options;
    const handleFetchConfig = () => {
        let config = {};
        let body;
        if (typeof method === 'undefined' || method === 'GET' || method === 'get') {
            config.method = 'GET';
        }
        else if (method === 'POST' || method === 'post') {
            // 默认不带 credentials
            if (includeCredentials === true) {
                config.credentials = 'include';
            }
            // contentType 默认 urlencoded
            if (typeof contentType === 'undefined' || contentType === 'urlencoded') {
                contentType = 'application/x-www-form-urlencoded';
                body = objectToUrlencoded(data);
            }
            else if (contentType === 'json') {
                contentType = 'application/json';
                body = JSON.stringify(data);
            }
            config = Object.assign({}, config, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': contentType,
                    'Access-Control-Request-Method': 'POST'
                },
                body
            });
        }
        else {
            console.error('Unsupported method');
        }
        return config;
    };
    const handleJsonp = () => {
        if (fullUrl.indexOf('douban') !== -1) {
            let id = new Date().valueOf();
            let jsonpId = 'jsonp-' + id;
            let jsonpCallback = 'jsonpCallback' + id;
            let jsonpCallbackData = `__JSONP_DATA_${id}__`;
            window[jsonpCallback] = function (data) {
                window[jsonpCallbackData] = data;
            };
            let script = document.createElement('script');
            script.setAttribute('src', `${fullUrl}&callback=${jsonpCallback}`);
            script.setAttribute('id', jsonpId);
            document.body.appendChild(script);
            return new Promise(resolve => {
                script.onload = function () {
                    document.body.removeChild(document.getElementById(jsonpId));
                    let json = window[jsonpCallbackData];
                    resolve(handleResponseJson(json, schema));
                };
            });
        }
    };
    if (useJsonp === true) {
        return handleJsonp();
    }
    return fetch(fullUrl, handleFetchConfig())
        .then(response => {
        return response.json().then(json => ({ json, response }));
    })
        .then(({ json, response }) => {
        if (response.ok) {
            return handleResponseJson(json, schema);
        }
        else {
            return Promise.reject(json);
        }
    });
}
export default callApi;

//# sourceMappingURL=data:application/json;base64,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LElBQUksQ0FBQyxRQUFRO1FBQ1osTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFBO0lBQzNELENBQUMsQ0FBQztTQUNELElBQUksQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRTtRQUN2QixFQUFFLENBQUEsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUNmLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUE7UUFDekMsQ0FBQztRQUFBLElBQUksQ0FBQSxDQUFDO1lBQ0osTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDN0IsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFBO0FBQ04sQ0FBQztBQUVELGVBQWUsT0FBTyxDQUFBIiwiZmlsZSI6InV0aWxzL2NhbGxBcGkuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgJ2lzb21vcnBoaWMtZmV0Y2gnXG5pbXBvcnQgeyBub3JtYWxpemUgfSBmcm9tICdub3JtYWxpenInXG5pbXBvcnQgaHVtcHMgZnJvbSAnaHVtcHMnXG5pbXBvcnQgb2JqZWN0VG9VcmxlbmNvZGVkIGZyb20gJ3V0aWxzL29iamVjdFRvVXJsZW5jb2RlZCdcblxuZGVjbGFyZSBsZXQgZmV0Y2hcblxuZXhwb3J0IGZ1bmN0aW9uIGhhbmRsZVJlc3BvbnNlSnNvbihqc29uLCBzY2hlbWEpIHtcbiAganNvbiA9IGh1bXBzLmNhbWVsaXplS2V5cyhqc29uKVxuICBsZXQgcmVzdWx0ID0ganNvblxuXG4gIGlmKHR5cGVvZiBzY2hlbWEgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgcmVzdWx0ID0gT2JqZWN0LmFzc2lnbih7fSxcbiAgICAgIG5vcm1hbGl6ZShqc29uLCBzY2hlbWEpXG4gICAgKVxuICB9XG5cbiAgcmV0dXJuIHJlc3VsdFxufVxuXG50eXBlIGNhbGxBcGlPcHRpb25zID0ge1xuICBmdWxsVXJsOiBzdHJpbmdcbiAgbWV0aG9kPzogc3RyaW5nXG4gIGRhdGE/OiB7fVxuICBzY2hlbWE/OiB7fVxuICBpbmNsdWRlQ3JlZGVudGlhbHM/OiBib29sZWFuXG4gIHVzZUpzb25wPzogYm9vbGVhblxuICAvLyB1cmxlbmNvZGVkIHwganNvblxuICBjb250ZW50VHlwZT86IGFueVxufVxuXG5leHBvcnQgZnVuY3Rpb24gY2FsbEFwaShvcHRpb25zOiBjYWxsQXBpT3B0aW9ucykge1xuICBsZXQgeyBmdWxsVXJsLCBtZXRob2QsIGRhdGEsIHNjaGVtYSwgaW5jbHVkZUNyZWRlbnRpYWxzLCB1c2VKc29ucCwgY29udGVudFR5cGUgfSA9IG9wdGlvbnNcbiAgXG4gIGNvbnN0IGhhbmRsZUZldGNoQ29uZmlnID0gKCkgPT4ge1xuICAgIHR5cGUgdHlwZWNvbmZpZyA9IHtcbiAgICAgIGNyZWRlbnRpYWxzPzogc3RyaW5nXG4gICAgICBtZXRob2Q/OiBzdHJpbmdcbiAgICB9XG5cbiAgICBsZXQgY29uZmlnOiB0eXBlY29uZmlnID0ge31cbiAgICBsZXQgYm9keVxuXG4gICAgaWYodHlwZW9mIG1ldGhvZCA9PT0gJ3VuZGVmaW5lZCcgfHwgbWV0aG9kID09PSAnR0VUJyB8fCBtZXRob2QgPT09J2dldCcpIHtcbiAgICAgIGNvbmZpZy5tZXRob2QgPSAnR0VUJ1xuICAgIH0gZWxzZSBpZiAobWV0aG9kID09PSAnUE9TVCcgfHwgbWV0aG9kID09PSAncG9zdCcpIHtcblxuICAgICAgLy8g6buY6K6k5LiN5bimIGNyZWRlbnRpYWxzXG4gICAgICBpZiAoaW5jbHVkZUNyZWRlbnRpYWxzID09PSB0cnVlKSB7XG4gICAgICAgIGNvbmZpZy5jcmVkZW50aWFscyA9ICdpbmNsdWRlJ1xuICAgICAgfVxuXG4gICAgICAvLyBjb250ZW50VHlwZSDpu5jorqQgdXJsZW5jb2RlZFxuICAgICAgaWYgKHR5cGVvZiBjb250ZW50VHlwZSA9PT0gJ3VuZGVmaW5lZCcgfHwgY29udGVudFR5cGUgPT09ICd1cmxlbmNvZGVkJykge1xuICAgICAgICBjb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnXG4gICAgICAgIGJvZHkgPSBvYmplY3RUb1VybGVuY29kZWQoZGF0YSkgICAgICAgIFxuICAgICAgfSBlbHNlIGlmIChjb250ZW50VHlwZSA9PT0gJ2pzb24nKSB7XG4gICAgICAgIGNvbnRlbnRUeXBlID0gJ2FwcGxpY2F0aW9uL2pzb24nXG4gICAgICAgIGJvZHkgPSBKU09OLnN0cmluZ2lmeShkYXRhKVxuICAgICAgfVxuICAgICAgXG4gICAgICBjb25maWcgPSBPYmplY3QuYXNzaWduKHt9LCBjb25maWcsIHtcbiAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAgICdDb250ZW50LVR5cGUnOiBjb250ZW50VHlwZSxcbiAgICAgICAgICAnQWNjZXNzLUNvbnRyb2wtUmVxdWVzdC1NZXRob2QnOiAnUE9TVCdcbiAgICAgICAgfSxcbiAgICAgICAgYm9keVxuICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5lcnJvcignVW5zdXBwb3J0ZWQgbWV0aG9kJylcbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIGNvbmZpZ1xuICB9XG5cbiAgY29uc3QgaGFuZGxlSnNvbnAgPSAoKSA9PiB7XG4gICAgaWYoZnVsbFVybC5pbmRleE9mKCdkb3ViYW4nKSAhPT0gLTEpIHtcbiAgICAgIGxldCBpZCA9IG5ldyBEYXRlKCkudmFsdWVPZigpXG4gICAgICBsZXQganNvbnBJZCA9ICdqc29ucC0nICsgaWRcbiAgICAgIGxldCBqc29ucENhbGxiYWNrID0gJ2pzb25wQ2FsbGJhY2snICsgaWRcbiAgICAgIGxldCBqc29ucENhbGxiYWNrRGF0YSA9IGBfX0pTT05QX0RBVEFfJHtpZH1fX2BcblxuICAgICAgd2luZG93W2pzb25wQ2FsbGJhY2tdID0gZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICB3aW5kb3dbanNvbnBDYWxsYmFja0RhdGFdID0gZGF0YVxuICAgICAgfVxuXG4gICAgICBsZXQgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0JylcblxuICAgICAgc2NyaXB0LnNldEF0dHJpYnV0ZSgnc3JjJywgYCR7ZnVsbFVybH0mY2FsbGJhY2s9JHtqc29ucENhbGxiYWNrfWApXG4gICAgICBzY3JpcHQuc2V0QXR0cmlidXRlKCdpZCcsIGpzb25wSWQpXG4gICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHNjcmlwdClcblxuICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgICBzY3JpcHQub25sb2FkID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChkb2N1bWVudC5nZXRFbGVtZW50QnlJZChqc29ucElkKSlcbiAgICAgICAgICBsZXQganNvbiA9IHdpbmRvd1tqc29ucENhbGxiYWNrRGF0YV1cblxuICAgICAgICAgIHJlc29sdmUoaGFuZGxlUmVzcG9uc2VKc29uKGpzb24sIHNjaGVtYSkpXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfVxuICB9XG5cbiAgaWYodXNlSnNvbnAgPT09IHRydWUpIHtcbiAgICByZXR1cm4gaGFuZGxlSnNvbnAoKVxuICB9XG5cbiAgcmV0dXJuIGZldGNoKGZ1bGxVcmwsIGhhbmRsZUZldGNoQ29uZmlnKCkpXG4gICAgLnRoZW4ocmVzcG9uc2UgPT4ge1xuICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKS50aGVuKGpzb24gPT4gKHsganNvbiwgcmVzcG9uc2UgfSkpXG4gICAgfSlcbiAgICAudGhlbigoeyBqc29uLCByZXNwb25zZSB9KSA9PiB7XG4gICAgICBpZihyZXNwb25zZS5vaykge1xuICAgICAgICByZXR1cm4gaGFuZGxlUmVzcG9uc2VKc29uKGpzb24sIHNjaGVtYSlcbiAgICAgIH1lbHNle1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoanNvbilcbiAgICAgIH1cbiAgICB9KVxufVxuXG5leHBvcnQgZGVmYXVsdCBjYWxsQXBpXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
